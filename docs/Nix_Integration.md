# Nix Integration

This document provides a detailed explanation of the Nix integration within the `rust-bootstrap-nix` project. This system is designed to create a reproducible and flexible build environment by dynamically resolving Nix store paths for all the tools and dependencies required for the Rust bootstrap process.

## The `generated_config.toml` File

The core of this system is the `generated_config.toml` file. This file is generated by the `bootstrap-config-builder` utility and contains the exact Nix store paths for all the tools and dependencies required for the build, including:

*   `rustc`: The Rust compiler.
*   `cargo`: The Rust package manager.
*   `nixpkgs`: The Nix Packages collection.
*   `rust-overlay`: A Nix overlay for Rust.
*   `rust-src-flake`: The Rust source code.

Here's an example of a `generated_config.toml` file:

```toml
# Generated by bootstrap-config-builder
#
# System: aarch64-linux
# Project Root: /path/to/rust-bootstrap-nix

[nix]
nixpkgs_path = "/nix/store/..."
rust_overlay_path = "/nix/store/..."
rust_bootstrap_nix_path = "/path/to/rust-bootstrap-nix"
configuration_nix_path = "/path/to/rust-bootstrap-nix/configuration-nix"
rust_src_flake_path = "/nix/store/..."
rust_bootstrap_nix_flake_ref = "github:meta-introspector/rust-bootstrap-nix?ref=feature/CRQ-016-nixify"
rust_src_flake_ref = "github:meta-introspector/rust?ref=feature/CRQ-016-nixify"

[rust]
rustc = "/nix/store/.../bin/rustc"
cargo = "/nix/store/.../bin/cargo"
# ...
```

## Dynamic Path Resolution

The Rust bootstrap process has been modified to read this `generated_config.toml` file and use the paths within it to configure the build. If the `generated_config.toml` file is not present, the bootstrap process will dynamically fetch the required Nix store paths using `nix flake prefetch` and `nix path-info`.

This is achieved through the `resolve_nix_paths` function in the `Config` struct, which is called during the bootstrap process. This function checks if the Nix paths are already set in the `Config` struct (from `generated_config.toml`). If not, it executes the necessary Nix commands to resolve the paths and updates the `Config` struct accordingly.

## Usage

To use this new system, you can either:

1.  **Generate `generated_config.toml` manually:** Run the `bootstrap-config-builder` with the desired `--rustc-path`, `--cargo-path`, and `--rust-src-flake-path` arguments. This gives you fine-grained control over the exact versions of the tools and dependencies used in the build.
2.  **Let the bootstrap process handle it:** If `generated_config.toml` is not present, the bootstrap process will automatically resolve the Nix paths for you. This is a convenient way to get up and running quickly, but it provides less control over the exact versions used.

## Generated Code Structure

The `generated/` directory serves as the output location for automatically generated code components. For each logical library or module identified during the lattice transformation process, the following files will be generated within this directory:

*   `Cargo.toml`: The manifest file for the Rust package, defining its dependencies, features, and other metadata.
*   `flake.nix`: A Nix flake definition for the generated library, ensuring its reproducible build and integration into the Nix ecosystem.
*   `lib.rs`: The primary source file for the Rust library, containing the actual Rust code.

This structured generation ensures that each component of the "lattice of functions" is self-contained, reproducible via Nix, and easily integrated into the overall project.

## Lattice of Nix Flakes

This dynamic, Nix-based configuration system is the foundation for creating a "lattice of Nix flakes." This allows us to precisely control and track every component of the Rust bootstrap process, from compiler stages to individual Cargo runs, all within the Nix ecosystem. This is a powerful tool for reproducible builds and toolchain experimentation, and it's a key step towards achieving the 8-fold recursion system for eBPF Rust bootstrapping.
