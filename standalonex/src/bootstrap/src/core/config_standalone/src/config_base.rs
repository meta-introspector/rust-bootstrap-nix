use crate::prelude::*;

/// Global configuration for the entire build and/or bootstrap.
///
/// This structure is parsed from `config.toml`, and some of the fields are inferred from `git` or build-time parameters.
///
/// Note that this structure is not decoded directly into, but rather it is
/// filled out from the decoded forms of the structs below. For documentation
/// each field, see the corresponding fields in
/// `config.example.toml`.
#[derive(Default, Clone)]
use crate::core::config::flags::{Color, Flags, Warnings};\nuse crate::core::config::lld_mode::LldMode;\nuse crate::core::config::rust_optimize::RustOptimize;\nuse crate::core::config::rustclto::RustcLto;\nuse crate::core::config::debug_info_level::DebuginfoLevel;\nuse crate::core::config::rustfmt::RustfmtState;\nuse crate::core::config::ci::CiConfig;\nuse crate::core::config::target::Target;\nuse crate::core::config::subcommand::Subcommand;\nuse crate::core::config::llvm_lib_unwind::LlvmLibunwind;\nuse crate::core::config_utils::parsed_config::ParsedConfig;\nuse std::process::Command;\nuse std::str::FromStr;\npub struct Config {\n    pub change_id: Option<usize>,\n    pub bypass_bootstrap_lock: bool,\n    pub ccache: Option<String>,\n    /// Call Build::ninja() instead of this.\n    pub ninja_in_file: bool,\n    pub verbose: usize,\n    pub submodules: Option<bool>,\n    pub compiler_docs: bool,\n    pub library_docs_private_items: bool,\n    pub docs_minification: bool,\n    pub docs: bool,\n    pub locked_deps: bool,\n    pub vendor: bool,\n    pub target_config: HashMap<TargetSelection, Target>,\n    pub full_bootstrap: bool,\n    pub bootstrap_cache_path: Option<PathBuf>,\n    pub extended: bool,\n    pub tools: Option<HashSet<String>>,\n    pub sanitizers: bool,\n    pub profiler: bool,\n    pub omit_git_hash: bool,\n    pub skip: Vec<PathBuf>,\n    pub include_default_paths: bool,\n    pub rustc_error_format: Option<String>,\n    pub json_output: bool,\n    pub test_compare_mode: bool,\n    pub color: Color,\n    pub patch_binaries_for_nix: Option<bool>,\n    pub stage0_path: Option<PathBuf>,\n    pub stage0_metadata: build_helper::stage0_parser::Stage0,\n    pub android_ndk: Option<PathBuf>,\n    /// Whether to use the `c` feature of the `compiler_builtins` crate.\n    pub optimized_compiler_builtins: bool,\n\n    pub stdout_is_tty: bool,\n    pub stderr_is_tty: bool,\n\n    pub on_fail: Option<String>,\n    pub stage: u32,\n    pub keep_stage: Vec<u32>,\n    pub keep_stage_std: Vec<u32>,\n    pub src: PathBuf,\n    /// defaults to `config.toml`\n    pub config: Option<PathBuf>,\n    pub jobs: Option<u32>,\n    pub cmd: Subcommand,\n    pub incremental: bool,\n    pub dry_run: DryRun,\n    pub dump_bootstrap_shims: bool,\n    /// Arguments appearing after `--` to be forwarded to tools,\n    /// e.g. `--fix-broken` or test arguments.\n    pub free_args: Vec<String>,\n\n    /// `None` if we shouldn\'t download CI compiler artifacts, or the commit to download if we should.\n    #[cfg(not(test))]\n    download_rustc_commit: Option<String>,\n    #[cfg(test)]\n    pub download_rustc_commit: Option<String>,\n\n    pub deny_warnings: bool,\n    pub backtrace_on_ice: bool,\n\n    // llvm codegen options\n    pub llvm_assertions: bool,\n    pub llvm_tests: bool,\n    pub llvm_enzyme: bool,\n    pub llvm_offload: bool,\n    pub llvm_plugins: bool,\n    pub llvm_optimize: bool,\n    pub llvm_thin_lto: bool,\n    pub llvm_release_debuginfo: bool,\n    pub llvm_static_stdcpp: bool,\n    pub llvm_libzstd: bool,\n    /// `None` if `llvm_from_ci` is true and we haven\'t yet downloaded llvm.\n    #[cfg(not(test))]\n    llvm_link_shared: Cell<Option<bool>>,\n    #[cfg(test)]\n    pub llvm_link_shared: Cell<Option<bool>>,\n    pub llvm_clang_cl: Option<String>,\n    pub llvm_targets: Option<String>,\n    pub llvm_experimental_targets: Option<String>,\n    pub llvm_link_jobs: Option<u32>,\n    pub llvm_version_suffix: Option<String>,\n    pub llvm_use_linker: Option<String>,\
    pub llvm_allow_old_toolchain: bool,\n    pub llvm_polly: bool,\n    pub llvm_clang: bool,\n    pub llvm_enable_warnings: bool,\n    pub llvm_from_ci: bool,\n    pub llvm_build_config: HashMap<String, String>,\n    pub llvm_enable_projects: Option<String>,\n\n    pub lld_mode: LldMode,\n    pub lld_enabled: bool,\n    pub llvm_tools_enabled: bool,\n    pub llvm_bitcode_linker_enabled: bool,\n\n    pub llvm_cflags: Option<String>,\n    pub llvm_cxxflags: Option<String>,\n    pub llvm_ldflags: Option<String>,\n    pub llvm_use_libcxx: bool,\n\n    // rust codegen options\n    pub rust_optimize: RustOptimize,\n    pub rust_codegen_units: Option<u32>,\n    pub rust_codegen_units_std: Option<u32>,\n\n    pub rustc_debug_assertions: bool,\n    pub std_debug_assertions: bool,\n\n    pub rust_overflow_checks: bool,\n    pub rust_overflow_checks_std: bool,\n    pub rust_debug_logging: bool,\n    pub rust_debuginfo_level_rustc: DebuginfoLevel,\n    pub rust_debuginfo_level_std: DebuginfoLevel,\n    pub rust_debuginfo_level_tools: DebuginfoLevel,\n    pub rust_debuginfo_level_tests: DebuginfoLevel,\n    pub rust_rpath: bool,\n    pub rust_strip: bool,\n    pub rust_frame_pointers: bool,\n    pub rust_stack_protector: Option<String>,\n    pub rustc_default_linker: Option<String>,\n    pub rust_optimize_tests: bool,\n    pub rust_dist_src: bool,\n    pub rust_codegen_backends: Vec<String>,\n    pub rust_verify_llvm_ir: bool,\n    pub rust_thin_lto_import_instr_limit: Option<u32>,\n    pub rust_randomize_layout: bool,\n    pub rust_remap_debuginfo: bool,\n    pub rust_new_symbol_mangling: Option<bool>,\n    pub rust_profile_use: Option<String>,\n    pub rust_profile_generate: Option<String>,\n    pub rust_lto: RustcLto,\n    pub rust_validate_mir_opts: Option<u32>,\n    pub rust_std_features: BTreeSet<String>,\n    pub llvm_profile_use: Option<String>,\n    pub llvm_profile_generate: bool,\n    pub llvm_libunwind_default: Option<LlvmLibunwind>,\n    pub enable_bolt_settings: bool,\n\n    pub reproducible_artifacts: Vec<String>,\n\n    pub build: TargetSelection,\n    pub hosts: Vec<TargetSelection>,\n    pub targets: Vec<TargetSelection>,\n    pub local_rebuild: bool,\n    pub jemalloc: bool,\n    pub control_flow_guard: bool,\n    pub ehcont_guard: bool,\n\n    // dist misc\n    pub dist_sign_folder: Option<PathBuf>,\n    pub dist_upload_addr: Option<String>,\n    pub dist_compression_formats: Option<Vec<String>>,\n    pub dist_compression_profile: String,\n    pub dist_include_mingw_linker: bool,\n    pub dist_vendor: bool,\n\n    // libstd features\n    pub backtrace: bool, // support for RUST_BACKTRACE\n\n    // misc\n    pub low_priority: bool,\n    pub channel: String,\n    pub description: Option<String>,\n    pub verbose_tests: bool,\n    pub save_toolstates: Option<PathBuf>,\n    pub print_step_timings: bool,\n    pub print_step_rusage: bool,\n\n    // Fallback musl-root for all targets\n    pub musl_root: Option<PathBuf>,\n    pub prefix: Option<PathBuf>,\n    pub sysconfdir: Option<PathBuf>,\n    pub datadir: Option<PathBuf>,\n    pub docdir: Option<PathBuf>,\n    pub bindir: PathBuf,\n    pub libdir: Option<PathBuf>,\n    pub mandir: Option<PathBuf>,\n    pub codegen_tests: bool,\n    pub nodejs: Option<PathBuf>,\n    pub npm: Option<PathBuf>,\n    pub gdb: Option<PathBuf>,\n    pub lldb: Option<PathBuf>,\n    pub python: Option<PathBuf>,\n    pub reuse: Option<PathBuf>,\n    pub cargo_native_static: bool,\n    pub configure_args: Vec<String>,\n    pub out: PathBuf,\n    pub rust_info: channel::GitInfo,\n\n    pub cargo_info: channel::GitInfo,\n    pub rust_analyzer_info: channel::GitInfo,\n    pub clippy_info: channel::GitInfo,\n    pub miri_info: channel::GitInfo,\n    pub rustfmt_info: channel::GitInfo,\n    pub enzyme_info: channel::GitInfo,\n    pub in_tree_llvm_info: channel::GitInfo,\n    pub in_tree_gcc_info: channel::GitInfo,\n\n    // These are either the stage0 downloaded binaries or the locally installed ones.\n    pub initial_cargo: PathBuf,\n    pub initial_rustc: PathBuf,\n    pub initial_cargo_clippy: Option<PathBuf>,\n\n    #[cfg(not(test))]\n    initial_rustfmt: RefCell<RustfmtState>,\n    #[cfg(test)]\n    pub initial_rustfmt: RefCell<RustfmtState>,\n\n    pub ci: CiConfig,\n\n    /// The paths to work with. For example: with `./x check foo bar` we get\n    /// `paths=[\"foo\", \"bar\"]`.\n    pub paths: Vec<PathBuf>,\n\n    /// Command for visual diff display, e.g. `diff-tool --color=always`.\n    pub compiletest_diff_tool: Option<String>,\n}\n\nimpl From<ParsedConfig> for Config {\n    fn from(parsed_config: ParsedConfig) -> Self {\n        let mut config = Config::default();\n\n        config.change_id = parsed_config.change_id.and_then(|s| s.parse().ok());\n        config.bypass_bootstrap_lock = parsed_config.bypass_bootstrap_lock;\n        config.verbose = parsed_config.verbose.unwrap_or(0);\n        config.submodules = parsed_config.submodules;\n        config.compiler_docs = parsed_config.compiler_docs.unwrap_or_default();\n        config.library_docs_private_items = parsed_config.library_docs_private_items.unwrap_or_default();\n        config.docs_minification = parsed_config.docs_minification.unwrap_or_default();\n        config.docs = parsed_config.docs.unwrap_or_default();\n        config.locked_deps = parsed_config.locked_deps.unwrap_or_default();\n        config.vendor = parsed_config.vendor.unwrap_or_default();\n        // config.target_config: HashMap<TargetSelection, Target>, // Complex, will need to be handled separately\n        config.full_bootstrap = parsed_config.full_bootstrap.unwrap_or_default();\n        config.bootstrap_cache_path = parsed_config.bootstrap_cache_path;\n        config.extended = parsed_config.extended.unwrap_or_default();\n        config.tools = parsed_config.tools;\n        config.sanitizers = parsed_config.sanitizers.unwrap_or_default();\n        config.profiler = parsed_config.profiler.unwrap_or_default();\n        config.omit_git_hash = parsed_config.omit_git_hash;\n        // config.skip: Vec<PathBuf>, // Needs mapping from Vec<String> if ParsedConfig has it\n        config.include_default_paths = true; // Default value\n        // config.rustc_error_format: Option<String>, // Direct map\n        // config.json_output: bool, // Direct map\n        // config.test_compare_mode: bool, // Direct map\n        // config.color: Color, // Needs conversion\n        config.patch_binaries_for_nix = parsed_config.patch_binaries_for_nix;\n        // config.stage0_path: Option<PathBuf>, // Direct map\n        // config.stage0_metadata: build_helper::stage0_parser::Stage0, // Complex\n        config.android_ndk = parsed_config.android_ndk;\n        config.optimized_compiler_builtins = parsed_config.optimized_compiler_builtins;\n\n        config.stdout_is_tty = parsed_config.stdout_is_tty.unwrap_or_default();\n        config.stderr_is_tty = parsed_config.stderr_is_tty.unwrap_or_default();\n\n        // config.on_fail: Option<String>, // Direct map\n        config.stage = parsed_config.stage.unwrap_or(0) as u32;\n        // config.keep_stage: Vec<u32>, // Needs mapping\n        // config.keep_stage_std: Vec<u32>, // Needs mapping\n        config.src = parsed_config.src;\n        config.config = parsed_config.config;\n        config.jobs = parsed_config.jobs.map(|j| j as u32);\n        // config.cmd: Subcommand, // Needs conversion\n        config.incremental = parsed_config.incremental;\n        config.dry_run = parsed_config.dry_run;\n        config.dump_bootstrap_shims = false; // Default value\n        // config.free_args: Vec<String>, // Direct map\n\n        config.download_rustc_commit = parsed_config.download_rustc_commit;\n\n        config.deny_warnings = parsed_config.deny_warnings.unwrap_or_default();\n        config.backtrace_on_ice = parsed_config.backtrace_on_ice.unwrap_or_default();\n\n        config.llvm_assertions = parsed_config.llvm_assertions.unwrap_or_default();\n        config.llvm_tests = parsed_config.llvm_tests;\n        config.llvm_enzyme = parsed_config.llvm_enzyme_flag.unwrap_or_default();\n        config.llvm_offload = parsed_config.llvm_offload;\n        config.llvm_plugins = parsed_config.llvm_plugins;\n        config.llvm_optimize = parsed_config.llvm_optimize.unwrap_or_default();\n        config.llvm_thin_lto = parsed_config.llvm_thin_lto;\n        config.llvm_release_debuginfo = parsed_config.llvm_release_debuginfo.unwrap_or_default();\n        config.llvm_static_stdcpp = parsed_config.llvm_static_stdcpp.unwrap_or_default();\n        config.llvm_libzstd = parsed_config.llvm_libzstd.unwrap_or_default();\n        // config.llvm_link_shared: Cell<Option<bool>>, // Complex\n        config.llvm_clang_cl = parsed_config.llvm_clang_cl;\n        // config.llvm_targets: Option<String>, // Needs conversion from Vec<String>\n        // config.llvm_experimental_targets: Option<String>, // Needs conversion from Vec<String>\n        config.llvm_link_jobs = parsed_config.llvm_link_jobs.map(|j| j as u32);\n        config.llvm_version_suffix = parsed_config.llvm_version_suffix;\n        config.llvm_use_linker = parsed_config.llvm_use_linker;\n        config.llvm_allow_old_toolchain = parsed_config.llvm_allow_old_toolchain;\n        config.llvm_polly = parsed_config.llvm_polly;\n        config.llvm_clang = parsed_config.llvm_clang;\n        config.llvm_enable_warnings = parsed_config.llvm_enable_warnings;\n        config.llvm_from_ci = parsed_config.llvm_from_ci;\n        // config.llvm_build_config: HashMap<String, String>, // Complex\n        // config.llvm_enable_projects: Option<String>, // Needs conversion from Vec<String>\n\n        // config.lld_mode: LldMode, // Needs conversion\n        config.lld_enabled = parsed_config.lld_enabled;\n        config.llvm_tools_enabled = parsed_config.llvm_tools_enabled;\n        config.llvm_bitcode_linker_enabled = parsed_config.llvm_bitcode_linker_enabled.unwrap_or_default();\n\n        // config.llvm_cflags: Option<String>, // Direct map\n        // config.llvm_cxxflags: Option<String>, // Direct map\n        // config.llvm_ldflags: Option<String>, // Direct map\n        config.llvm_use_libcxx = parsed_config.llvm_use_libcxx.unwrap_or_default();\n\n        // config.rust_optimize: RustOptimize, // Needs conversion\n        config.rust_codegen_units = parsed_config.rust_codegen_units.map(|u| u as u32);\n        config.rust_codegen_units_std = parsed_config.rust_codegen_units_std.map(|u| u as u32);\n\n        config.rustc_debug_assertions = parsed_config.rustc_debug_assertions;\n        config.std_debug_assertions = parsed_config.std_debug_assertions;\n\n        config.rust_overflow_checks = parsed_config.rust_overflow_checks;\n        config.rust_overflow_checks_std = parsed_config.rust_overflow_checks_std;\n        config.rust_debug_logging = parsed_config.rust_debug_logging;\n        // config.rust_debuginfo_level_rustc: DebuginfoLevel, // Needs conversion\n        // config.rust_debuginfo_level_std: DebuginfoLevel, // Needs conversion\n        // config.rust_debuginfo_level_tools: DebuginfoLevel, // Needs conversion\n        // config.rust_debuginfo_level_tests: DebuginfoLevel, // Needs conversion\n        config.rust_rpath = parsed_config.rust_rpath.unwrap_or_default();\n        config.rust_strip = parsed_config.rust_strip.unwrap_or_default();\n        config.rust_frame_pointers = parsed_config.rust_frame_pointers.unwrap_or_default();\n        // config.rust_stack_protector: Option<String>, // Direct map\n        config.rustc_default_linker = parsed_config.rustc_default_linker;\n        config.rust_optimize_tests = parsed_config.rust_optimize_tests.unwrap_or_default();\n        config.rust_dist_src = parsed_config.rust_dist_src.unwrap_or_default();\n        config.rust_codegen_backends = parsed_config.rust_codegen_backends;\n        config.rust_verify_llvm_ir = parsed_config.rust_verify_llvm_ir.unwrap_or_default();\n        config.rust_thin_lto_import_instr_limit = parsed_config.rust_thin_lto_import_instr_limit;\n        config.rust_randomize_layout = parsed_config.rust_randomize_layout;\n        config.rust_remap_debuginfo = parsed_config.rust_remap_debuginfo.unwrap_or_default();\n        config.rust_new_symbol_mangling = parsed_config.rust_new_symbol_mangling;\n        // config.rust_profile_use: Option<String>, // Direct map\n        config.rust_profile_generate = parsed_config.rust_profile_generate.map(|b| b.to_string());\n        // config.rust_lto: RustcLto, // Needs conversion\n        // config.rust_validate_mir_opts: Option<u32>, // Direct map\n        config.rust_std_features = parsed_config.rust_std_features;\n        // config.llvm_profile_use: Option<String>, // Direct map\n        config.llvm_profile_generate = parsed_config.llvm_profile_generate;\n        // config.llvm_libunwind_default: Option<LlvmLibunwind>, // Needs conversion\n        config.enable_bolt_settings = false; // Default value\n\n        // config.reproducible_artifacts: Vec<String>, // Direct map\n\n        config.build = parsed_config.build;\n        config.hosts = parsed_config.hosts.into_iter().map(TargetSelection::from).collect();\n        config.targets = parsed_config.targets.into_iter().map(TargetSelection::from).collect();\n        config.local_rebuild = parsed_config.local_rebuild.unwrap_or_default();\n        config.jemalloc = parsed_config.jemalloc.unwrap_or_default();\n        config.control_flow_guard = parsed_config.control_flow_guard.unwrap_or_default();\n        config.ehcont_guard = parsed_config.ehcont_guard.unwrap_or_default();\n\n        config.dist_sign_folder = parsed_config.dist_sign_folder;\n        config.dist_upload_addr = parsed_config.dist_upload_addr;\n        config.dist_compression_formats = parsed_config.dist_compression_formats;\n        config.dist_compression_profile = parsed_config.dist_compression_profile.unwrap_or_default();\n        config.dist_include_mingw_linker = parsed_config.dist_include_mingw_linker.unwrap_or_default();\n        config.dist_vendor = parsed_config.dist_vendor;\n\n        config.backtrace = parsed_config.backtrace.unwrap_or_default();\n\n        config.low_priority = parsed_config.low_priority.unwrap_or_default();\n        config.channel = parsed_config.channel.unwrap_or_default();\n        config.description = parsed_config.description;\n        config.verbose_tests = parsed_config.verbose_tests_flag.unwrap_or_default();\n        config.save_toolstates = parsed_config.save_toolstates;\n        config.print_step_timings = parsed_config.print_step_timings.unwrap_or_default();\n        config.print_step_rusage = parsed_config.print_step_rusage.unwrap_or_default();\n\n        config.musl_root = parsed_config.musl_root;\n        config.prefix = parsed_config.prefix;\n        config.sysconfdir = parsed_config.sysconfdir;\n        config.datadir = parsed_config.datadir;\n        config.docdir = parsed_config.docdir;\n        config.bindir = parsed_config.bindir.unwrap_or_default();\n        config.libdir = parsed_config.libdir;\n        config.mandir = parsed_config.mandir;\n        config.codegen_tests = parsed_config.codegen_tests.unwrap_or_default();\n        config.nodejs = parsed_config.nodejs;\n        config.npm = parsed_config.npm;\n        config.gdb = parsed_config.gdb;\n        config.lldb = parsed_config.lldb;\n        config.python = parsed_config.python;\n        config.reuse = parsed_config.reuse;\n        config.cargo_native_static = parsed_config.cargo_native_static.unwrap_or_default();\n        // config.configure_args: Vec<String>, // Direct map\n        config.out = parsed_config.out_dir.unwrap_or_else(|| \"build\".into());\n        // config.rust_info: channel::GitInfo, // Complex\n\n        // config.cargo_info: channel::GitInfo, // Complex\n        // config.rust_analyzer_info: channel::GitInfo, // Complex\n        // config.clippy_info: channel::GitInfo, // Complex\n        // config.miri_info: channel::GitInfo, // Complex\n        // config.rustfmt_info: channel::GitInfo, // Complex\n        // config.enzyme_info: channel::GitInfo, // Complex\n        // config.in_tree_llvm_info: channel::GitInfo, // Complex\n        // config.in_tree_gcc_info: channel::GitInfo, // Complex\n\n        config.initial_cargo = parsed_config.initial_cargo.unwrap_or_default();\n        config.initial_rustc = parsed_config.initial_rustc.unwrap_or_default();\n        config.initial_cargo_clippy = parsed_config.initial_cargo_clippy.map(|b| if b { Some(PathBuf::from(\"true\")) } else { None }).flatten();\n\n        // config.initial_rustfmt: RefCell<RustfmtState>, // Complex\n\n        // config.ci: CiConfig, // Complex\n\n        config.paths = parsed_config.paths;\n\n        config.compiletest_diff_tool = parsed_config.compiletest_diff_tool;\n\n        // Nix-related fields\n        config.nixpkgs_path = parsed_config.nixpkgs_path.map(PathBuf::from);\n        config.rust_overlay_path = parsed_config.rust_overlay_path.map(PathBuf::from);\n        config.rust_bootstrap_nix_path = parsed_config.rust_bootstrap_nix_path.map(PathBuf::from);\n        config.configuration_nix_path = parsed_config.configuration_nix_path.map(PathBuf::from);\n        config.rust_src_flake_path = parsed_config.rust_src_flake_path.map(PathBuf::from);\n        config.rust_bootstrap_nix_flake_ref = parsed_config.rust_bootstrap_nix_flake_ref;\n        config.rust_src_flake_ref = parsed_config.rust_src_flake_ref;\n\n        config\n    }\n}\n
