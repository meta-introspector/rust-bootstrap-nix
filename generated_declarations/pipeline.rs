pub mod pipeline { use anyhow :: Context ; use std :: path :: PathBuf ; use crate :: args :: Args ; use crate :: config_parser :: Config ; use pipeline_traits :: { RawFile , ValidatedFile , PipelineFunctor } ; use crate :: parser :: ParseFunctor ; use crate :: prelude_category_pipeline :: { ExtractUsesFunctor , ClassifyUsesFunctor , AstReconstructionFunctor , } ; use crate :: measurement ; pub async fn run_category_pipeline < W : tokio :: io :: AsyncWriteExt + Unpin + Send > (writer : & mut W , file_content : & str , file_path_str : & str , _args : & Args , _config : & Option < Config > ,) -> anyhow :: Result < () > { let raw_file = RawFile (file_path_str . to_string () , file_content . to_string ()) ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("---\n--- Stage 1: Parsing ---\n") ,) }) . as_bytes () ,) . await ? ; let parse_functor = ParseFunctor ; let parsed_file = parse_functor . map (writer , raw_file) . await . context ("Parsing failed") ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("  -> Parsed file successfully.\n") ,) }) . as_bytes () ,) . await ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("---\n--- Stage 2: Extracting Use Statements ---\n" ,) ,) }) . as_bytes () ,) . await ? ; let extract_uses_functor = ExtractUsesFunctor ; let use_statements = extract_uses_functor . map (writer , parsed_file . clone ()) . await . context ("Extracting use statements failed") ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("  -> Extracted {0} use statements.\n" , use_statements . 0 . len () ,) ,) }) . as_bytes () ,) . await ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("---\n--- Stage 3: Classifying Use Statements ---\n" ,) ,) }) . as_bytes () ,) . await ? ; let classify_uses_functor = ClassifyUsesFunctor ; let classified_uses = classify_uses_functor . map (writer , use_statements) . await . context ("Classifying use statements failed") ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("  -> Classified use statements:\n") ,) }) . as_bytes () ,) . await ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("{0:#?}\n" , classified_uses)) }) . as_bytes () ,) . await ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("---\n--- Stage 4: AST Reconstruction from Hugging Face Dataset ---\n" ,) ,) }) . as_bytes () ,) . await ? ; let ast_reconstruction_functor = AstReconstructionFunctor ; let validated_file = ValidatedFile (parsed_file . 0 . clone () , parsed_file . 1 . clone ()) ; let reconstructed_code = PipelineFunctor :: map (& ast_reconstruction_functor , writer , validated_file . clone () ,) . await . context ("AST Reconstruction failed") ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("  -> AST Reconstruction completed successfully.\n" ,) ,) }) . as_bytes () ,) . await ? ; let output_file_path = PathBuf :: from ("generated/self_generated_code.rs") ; tokio :: fs :: create_dir_all (output_file_path . parent () . unwrap ()) . await ? ; tokio :: fs :: write (& output_file_path , reconstructed_code . as_bytes ()) . await . context (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("Failed to write generated code to {0:?}" , output_file_path ,) ,) }) ,) ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("  -> Generated code written to {0:?}\n" , output_file_path ,) ,) }) . as_bytes () ,) . await ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("---\n--- Validating Generated Code ---\n") ,) }) . as_bytes () ,) . await ? ; crate :: utils :: validate_rust_code (& output_file_path) . await . context (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("Generated code validation failed for {0:?}" , output_file_path ,) ,) }) ,) ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("  -> Generated code validated successfully.\n") ,) }) . as_bytes () ,) . await ? ; let collected_metrics = measurement :: get_collected_metrics () ; let json_metrics = serde_json :: to_string_pretty (& collected_metrics) . context ("Failed to serialize metrics to JSON") ? ; writer . write_all (:: alloc :: __export :: must_use ({ :: alloc :: fmt :: format (format_args ! ("---\n--- METRICS_START ---\n{0}\n--- METRICS_END ---\n" , json_metrics ,) ,) }) . as_bytes () ,) . await ? ; Ok (()) } }