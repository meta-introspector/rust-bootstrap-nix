mod ext { # [doc = " A trait for adding some helper routines to pointers."] pub (crate) trait Pointer { # [doc = " Returns the distance, in units of `T`, between `self` and `origin`."] # [doc = ""] # [doc = " # Safety"] # [doc = ""] # [doc = " Same as `ptr::offset_from` in addition to `self >= origin`."] unsafe fn distance (self , origin : Self) -> usize ; # [doc = " Casts this pointer to `usize`."] # [doc = ""] # [doc = " Callers should not convert the `usize` back to a pointer if at all"] # [doc = " possible. (And if you believe it's necessary, open an issue to discuss"] # [doc = " why. Otherwise, it has the potential to violate pointer provenance.)"] # [doc = " The purpose of this function is just to be able to do arithmetic, i.e.,"] # [doc = " computing offsets or alignments."] fn as_usize (self) -> usize ; } impl < T > Pointer for * const T { unsafe fn distance (self , origin : * const T) -> usize { usize :: try_from (self . offset_from (origin)) . unwrap_unchecked () } fn as_usize (self) -> usize { self as usize } } impl < T > Pointer for * mut T { unsafe fn distance (self , origin : * mut T) -> usize { (self as * const T) . distance (origin as * const T) } fn as_usize (self) -> usize { (self as * const T) . as_usize () } } }